# Btrfså¿«ç…§ç®¡ç†å™¨ - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸš€ ä¸€é”®éƒ¨ç½²

åœ¨ä½ çš„DebianæœåŠ¡å™¨ `192.168.100.97` ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. ä¸‹è½½éƒ¨ç½²è„šæœ¬
curl -O https://raw.githubusercontent.com/redyuan43/btrfs-snapshot-manager/master/deploy.sh

# 2. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x deploy.sh

# 3. æ‰§è¡Œä¸€é”®éƒ¨ç½²
sudo ./deploy.sh
```

## ğŸ“‹ éƒ¨ç½²æµç¨‹

éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. **ç¯å¢ƒæ£€æŸ¥**
   - æ£€æŸ¥Debianç³»ç»Ÿ
   - éªŒè¯Dockerå®‰è£…
   - å®‰è£…Docker Composeï¼ˆå¦‚æœéœ€è¦ï¼‰
   - å®‰è£…Btrfså·¥å…·

2. **ç›®å½•è®¾ç½®**
   - åˆ›å»º `/opt/btrfs-snapshot-manager` (éƒ¨ç½²ç›®å½•)
   - åˆ›å»º `/data/monitored` (ç›‘æ§ç›®å½•)
   - åˆ›å»º `/data/snapshots` (å¿«ç…§ç›®å½•)

3. **ä»£ç éƒ¨ç½²**
   - ä»GitHubæ‹‰å–æœ€æ–°ä»£ç 
   - é…ç½®ç”Ÿäº§ç¯å¢ƒå‚æ•°

4. **æœåŠ¡å¯åŠ¨**
   - æ„å»ºDockeré•œåƒ
   - å¯åŠ¨æœåŠ¡å®¹å™¨
   - é…ç½®å¥åº·æ£€æŸ¥

5. **ç›‘æ§é…ç½®**
   - è®¾ç½®ç³»ç»Ÿç›‘æ§
   - é…ç½®æ—¥å¿—è½®è½¬
   - å®‰è£…å®šæ—¶ä»»åŠ¡

## ğŸ–¥ï¸ è®¿é—®ç•Œé¢

éƒ¨ç½²æˆåŠŸåï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **Webç®¡ç†ç•Œé¢**: http://192.168.100.97
- **APIæ¥å£**: http://192.168.100.97:5000/api
- **å®¹å™¨ç®¡ç†**: http://192.168.100.97:9000 (Portainer)

## âš™ï¸ é…ç½®å¿«ç…§ç›‘æ§

1. æ‰“å¼€Webç®¡ç†ç•Œé¢
2. åœ¨"ç›‘æ§é…ç½®"éƒ¨åˆ†è®¾ç½®ï¼š
   - **ç›‘æ§è·¯å¾„**: ä½ æƒ³ç›‘æ§çš„Btrfså­å·è·¯å¾„
   - **å¿«ç…§ç›®å½•**: å¿«ç…§å­˜å‚¨è·¯å¾„ï¼ˆé»˜è®¤ `/data/snapshots`ï¼‰
   - **æœ€å¤§å¿«ç…§æ•°**: å»ºè®®50ä¸ª
   - **å†·å´æ—¶é—´**: å»ºè®®300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

3. ç‚¹å‡»"ä¿å­˜é…ç½®"
4. ç‚¹å‡»"å¯åŠ¨ç›‘æ§"

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Webæµè§ˆå™¨     â”‚â”€â”€â”€â”€â”‚   Nginxå®¹å™¨     â”‚â”€â”€â”€â”€â”‚   APIå®¹å™¨       â”‚
â”‚  (ç«¯å£ 80)      â”‚    â”‚  (åå‘ä»£ç†)     â”‚    â”‚  (ç«¯å£ 5000)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚  ä¸»æœºBtrfs      â”‚
                                           â”‚  æ–‡ä»¶ç³»ç»Ÿ       â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
cd /opt/btrfs-snapshot-manager

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f

# é‡å¯æœåŠ¡
docker-compose restart

# åœæ­¢æœåŠ¡
docker-compose down

# å¯åŠ¨æœåŠ¡
docker-compose up -d
```

### æ›´æ–°ç³»ç»Ÿ
```bash
# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
sudo /opt/btrfs-snapshot-manager/deploy.sh update

# æˆ–è€…æ‰‹åŠ¨æ›´æ–°
cd /opt/btrfs-snapshot-manager
git pull
docker-compose build
docker-compose up -d
```

### å¤‡ä»½å’Œæ¢å¤
```bash
# å¤‡ä»½é…ç½®
tar -czf btrfs-backup-$(date +%Y%m%d).tar.gz /opt/btrfs-snapshot-manager/config

# æ¢å¤é…ç½®
tar -xzf btrfs-backup-20250913.tar.gz -C /
```

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### è‡ªåŠ¨ç›‘æ§
ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹ç›‘æ§ä»»åŠ¡ï¼š

- **æ¯5åˆ†é’Ÿ**: å¥åº·æ£€æŸ¥
- **æ¯10åˆ†é’Ÿ**: ç³»ç»ŸæŒ‡æ ‡æ”¶é›†
- **æ¯å°æ—¶**: è‡ªåŠ¨é‡å¯ä¸å¥åº·å®¹å™¨
- **æ¯å¤©**: ç”Ÿæˆç›‘æ§æŠ¥å‘Š
- **æ¯å‘¨**: æ£€æŸ¥ç³»ç»Ÿæ›´æ–°

### å‘Šè­¦é…ç½®

ç¼–è¾‘ `/opt/btrfs-snapshot-manager/monitoring/monitoring.yaml`ï¼š

```yaml
alerting:
  email:
    enabled: true
    smtp_server: "your-smtp-server.com"
    recipients:
      - "admin@yourdomain.com"
```

### æŸ¥çœ‹ç›‘æ§æŠ¥å‘Š
```bash
# æŸ¥çœ‹æœ€æ–°ç›‘æ§æŠ¥å‘Š
ls -la /var/lib/btrfs-monitor/daily_report_*.html

# åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
firefox /var/lib/btrfs-monitor/daily_report_$(date +%Y%m%d).html
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å®¹å™¨æ— æ³•å¯åŠ¨**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   docker-compose logs

   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   df -h

   # æ£€æŸ¥DockeræœåŠ¡
   systemctl status docker
   ```

2. **å¿«ç…§åˆ›å»ºå¤±è´¥**
   ```bash
   # æ£€æŸ¥Btrfså­å·
   btrfs subvolume show /data/monitored

   # æ£€æŸ¥æƒé™
   ls -la /data/

   # æ‰‹åŠ¨æµ‹è¯•å¿«ç…§
   btrfs subvolume snapshot /data/monitored /data/snapshots/test
   ```

3. **Webç•Œé¢æ— æ³•è®¿é—®**
   ```bash
   # æ£€æŸ¥å®¹å™¨çŠ¶æ€
   docker-compose ps

   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tlnp | grep :80

   # é‡å¯Webå®¹å™¨
   docker-compose restart btrfs-web
   ```

### æ—¥å¿—ä½ç½®

- **åº”ç”¨æ—¥å¿—**: `/var/log/btrfs-snapshot-manager/`
- **éƒ¨ç½²æ—¥å¿—**: `/var/log/btrfs-deploy.log`
- **å®¹å™¨æ—¥å¿—**: `docker-compose logs`
- **ç›‘æ§æ—¥å¿—**: `/var/log/btrfs-snapshot-manager/monitor.log`

## ğŸ” å®‰å…¨å»ºè®®

1. **é˜²ç«å¢™é…ç½®**
   ```bash
   # åªå…è®¸å†…ç½‘è®¿é—®
   ufw allow from 192.168.100.0/24 to any port 80
   ufw allow from 192.168.100.0/24 to any port 5000
   ```

2. **å®šæœŸå¤‡ä»½**
   - é…ç½®æ–‡ä»¶å¤‡ä»½
   - å…³é”®å¿«ç…§å¤‡ä»½
   - æ•°æ®åº“å¤‡ä»½ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

3. **è®¿é—®æ§åˆ¶**
   - è€ƒè™‘æ·»åŠ è®¤è¯æœºåˆ¶
   - é™åˆ¶APIè®¿é—®æ¥æº
   - å®šæœŸæ›´æ–°ç³»ç»Ÿ

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ `/var/log/btrfs-deploy.log` æ—¥å¿—
2. è¿è¡Œå¥åº·æ£€æŸ¥: `bash /opt/btrfs-snapshot-manager/monitoring/health_check.sh`
3. æäº¤Issueåˆ°GitHubä»“åº“

## ğŸ“ æ›´æ–°è®°å½•

- **v2.0**: æ·»åŠ Dockerå®¹å™¨åŒ–æ”¯æŒ
- **v2.1**: æ·»åŠ Webç®¡ç†ç•Œé¢
- **v2.2**: æ·»åŠ å®Œæ•´ç›‘æ§ç³»ç»Ÿ